{% extends "layout.html" %}
{% block body %}
<div class="budget-container stack">

  <div class="card section-card">
    {% include "_projet_budget_header.html" %}
  </div>

  {% set total_charges = budget_stats.total_charges or 0 %}
  {% set total_charges_financees = budget_stats.total_charges_ventile or 0 %}
  {% set total_charges_reste = budget_stats.total_charges_reste or 0 %}
  {% set total_demande = budget_stats.total_demande or 0 %}
  {% set total_accorde = budget_stats.total_accorde or 0 %}
  {% set total_recu = budget_stats.total_recu or 0 %}
  {% set total_produits = budget_stats.base_produits or 0 %}
  {% set produits_label = budget_stats.base_label or "demandé" %}
  {% set ecart = total_charges - total_produits %}
  {% set pct_ecart = (ecart / total_charges * 100) if total_charges else 0 %}
  {% set pct_finance_raw = (total_charges_financees / total_charges * 100) if total_charges else 0 %}
  {% set pct_finance = 100 if pct_finance_raw > 100 else pct_finance_raw %}
  {% set pct_non_finance = (total_charges_reste / total_charges * 100) if total_charges else 0 %}
  {% set produits_attendus = total_accorde if total_accorde > 0 else total_demande %}
  {% set pct_recu_raw = (total_recu / produits_attendus * 100) if produits_attendus else 0 %}
  {% set pct_recu = 100 if pct_recu_raw > 100 else pct_recu_raw %}
  {% set pct_securisation = (total_recu / produits_attendus * 100) if produits_attendus else 0 %}

  {% if ecart <= 0 %}
    {% set statut_phrase = "équilibré" %}
    {% set ecart_class = "kpi-value--ok" %}
  {% elif pct_ecart <= 10 %}
    {% set statut_phrase = "fragile" %}
    {% set ecart_class = "kpi-value--warn" %}
  {% else %}
    {% set statut_phrase = "à risque" %}
    {% set ecart_class = "kpi-value--danger" %}
  {% endif %}

  <section class="card budget-section">
    <h2 class="section-title">Synthèse financière</h2>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Budget total</div>
        <div class="kpi-value">{{ "%.2f"|format(total_charges) }}€</div>
        <div class="kpi-help">Prévisionnel global du projet.</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Charges totales</div>
        <div class="kpi-value">{{ "%.2f"|format(total_charges) }}€</div>
        <div class="kpi-help">Somme des charges prévues.</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Produits totaux ({{ produits_label }})</div>
        <div class="kpi-value">{{ "%.2f"|format(total_produits) }}€</div>
        <div class="kpi-help">Base la plus solide disponible.</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Écart global (charges - produits)</div>
        <div class="kpi-value {{ ecart_class }}">{{ "%.2f"|format(ecart) }}€</div>
        <div class="kpi-help">Seul indicateur coloré.</div>
      </div>
    </div>
  </section>

  <section class="card budget-section">
    <div class="balance-header">
      <h2 class="section-title">Barre d’équilibre du projet</h2>
      <p class="muted">Visualisation rapide de la part financée et de la part à couvrir.</p>
    </div>
    <div class="balance-bar" role="img" aria-label="Barre d'équilibre du budget">
      <div class="balance-segment balance-segment--ok" style="width: {{ pct_finance }}%;">
        {% if pct_finance > 12 %}Financé{% endif %}
      </div>
      <div class="balance-segment balance-segment--warn" style="width: {{ pct_non_finance }}%;">
        {% if pct_non_finance > 12 %}À couvrir{% endif %}
      </div>
    </div>
    <div class="balance-legend">
      <span><strong>{{ "%.0f"|format(pct_finance) }}%</strong> financé ({{ "%.2f"|format(total_charges_financees) }}€)</span>
      <span><strong>{{ "%.0f"|format(pct_non_finance) }}%</strong> à couvrir ({{ "%.2f"|format(total_charges_reste) }}€)</span>
    </div>
  </section>

  <section class="card budget-section budget-watch">
    <h2 class="section-title">À surveiller</h2>
    <ul class="watch-list">
      {% for a in alertes[:3] %}
        {% if "Charge non financée" in a %}
          {% set detail = a.replace("Charge non financée : ", "") %}
          <li>Une charge reste à financer : {{ detail }}.</li>
        {% elif "Produit non ventilé" in a %}
          {% set detail = a.replace("Produit non ventilé : ", "") %}
          <li>Un financement est encore à ventiler : {{ detail }}.</li>
        {% else %}
          <li>{{ a }}</li>
        {% endif %}
      {% else %}
        <li class="muted">Rien de bloquant identifié : la trajectoire est claire.</li>
      {% endfor %}
    </ul>
    {% if alertes|length > 3 %}
      <div class="muted small">+ {{ alertes|length - 3 }} autre(s) point(s) à vérifier.</div>
    {% endif %}
  </section>

  <section class="card budget-section">
    <h2 class="section-title">Aperçu charges &amp; produits</h2>
    <div class="macro-grid">
      <div class="macro-card">
        <h3>Charges</h3>
        <div class="macro-line">
          <span class="muted">Charges totales</span>
          <strong>{{ "%.2f"|format(total_charges) }}€</strong>
        </div>
        <div class="macro-line">
          <span class="muted">Charges financées</span>
          <strong>{{ "%.2f"|format(total_charges_financees) }}€</strong>
        </div>
        <div class="macro-line">
          <span class="muted">Charges non financées</span>
          <strong>{{ "%.2f"|format(total_charges_reste) }}€</strong>
        </div>
        <div class="mini-bar">
          <div class="mini-segment mini-segment--ok" style="width: {{ pct_finance }}%;"></div>
          <div class="mini-segment mini-segment--warn" style="width: {{ pct_non_finance }}%;"></div>
        </div>
      </div>

      <div class="macro-card">
        <h3>Produits</h3>
        <div class="macro-line">
          <span class="muted">Produits obtenus</span>
          <strong>{{ "%.2f"|format(total_recu) }}€</strong>
        </div>
        <div class="macro-line">
          <span class="muted">Produits attendus</span>
          <strong>{{ "%.2f"|format(produits_attendus) }}€</strong>
        </div>
        <div class="macro-line">
          <span class="muted">Taux de sécurisation</span>
          <strong>{{ "%.0f"|format(pct_securisation) }}%</strong>
        </div>
        <div class="mini-bar">
          <div class="mini-segment mini-segment--accent" style="width: {{ pct_recu }}%;"></div>
          <div class="mini-segment mini-segment--soft" style="width: {{ 100 - pct_recu }}%;"></div>
        </div>
      </div>
    </div>
  </section>

  <section class="card budget-section cta-section">
    <h2 class="section-title">Accès aux détails</h2>
    <div class="cta-row">
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('projets.projet_budget_charges', projet_id=projet.id) }}">Voir les charges</a>
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('projets.projet_budget_produits', projet_id=projet.id) }}">Voir les produits</a>
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('projets.projet_budget_ventilation', projet_id=projet.id) }}">Voir la ventilation / financeurs</a>
    </div>
  </section>

  <section class="card budget-section synthesis-sentence">
    <p>
      Le projet est actuellement <strong>{{ statut_phrase }}</strong>,
      et {{ "%.0f"|format(pct_non_finance) }} % du budget reste à financer
      ({{ "%.2f"|format(total_charges_reste) }}€).
    </p>
  </section>

</div>

<script>
  document.querySelectorAll("[data-watch-toggle]").forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = document.getElementById(btn.dataset.watchToggle);
      if (!target) return;
      target.classList.toggle("watch-list--hidden");
      btn.textContent = target.classList.contains("watch-list--hidden")
        ? btn.textContent.replace("Masquer", "Voir")
        : "Masquer les alertes";
    });
  });
</script>
{% endblock %}
