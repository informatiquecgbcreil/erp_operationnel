{% extends "layout.html" %}
{% block body %}
<div class="stack">

  <div class="card">
    {% include "_projet_budget_header.html" %}

    <div class="spacer"></div>
    <div class="muted">
      Astuce : vide une case (=0) pour supprimer la ventilation. C’est une matrice simple, façon Excel.
    </div>
  </div>

  <div class="card">
    <form method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Charge \\ Financeur</th>
              {% for p in produits %}
                <th>{{ p.financeur }}<br><span class="muted">{{ "%.0f"|format(p.montant_accorde or 0) }}€</span></th>
              {% endfor %}
              <th>Total ventilé</th>
              <th>Reste</th>
            </tr>
          </thead>
          <tbody>
            {% for c in charges %}
              <tr>
                <td>
                  <strong>{{ c.code_plan }}</strong> — {{ c.libelle }}<br>
                  <span class="muted">{{ "%.0f"|format(c.montant_previsionnel or 0) }}€</span>
                </td>
                {% for p in produits %}
                  {% set val = vvals.get((c.id, p.id), 0) %}
                  <td style="min-width:140px">
                    <input type="number" step="0.01" name="v_{{ c.id }}_{{ p.id }}" value="{{ val if val else '' }}" placeholder="0" style="width:120px">
                  </td>
                {% endfor %}
                <td>{{ "%.2f"|format(c.ventile or 0) }}€</td>
                <td>{{ "%.2f"|format(c.reste_a_financer or 0) }}€</td>
              </tr>
            {% else %}
              <tr><td colspan="{{ (produits|length) + 3 }}" class="muted">Ajoute d’abord des charges et des produits.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="spacer"></div>
      <button class="btn ok" type="submit">Enregistrer la ventilation</button>
    </form>
  </div>

</div>
{% endblock %}
