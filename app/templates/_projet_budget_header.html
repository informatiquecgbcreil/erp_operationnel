{% set bs = budget_stats|default({
    'total_charges': 0,
    'base_produits': 0,
    'base_label': 'demand√©'
}, true) %}

{% set total_charges = bs.total_charges or 0 %}
{% set total_produits = bs.base_produits or 0 %}
{% set ecart = total_charges - total_produits %}
{% set pct_ecart = (ecart / total_charges * 100) if total_charges else 0 %}
{% if ecart <= 0 %}
  {% set statut_label = "√âquilibr√©" %}
  {% set statut_class = "status-ok" %}
  {% set statut_emoji = "üü¢" %}
{% elif pct_ecart <= 10 %}
  {% set statut_label = "Fragile" %}
  {% set statut_class = "status-warn" %}
  {% set statut_emoji = "üü†" %}
{% else %}
  {% set statut_label = "√Ä risque" %}
  {% set statut_class = "status-danger" %}
  {% set statut_emoji = "üî¥" %}
{% endif %}
{% set tab = active_tab|default('') %}

<div class="budget-header">
  <div class="budget-header__top">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('projets.projets_edit', projet_id=projet.id) }}">‚Üê Retour projet</a>
    <span class="status-badge {{ statut_class }}">{{ statut_emoji }} {{ statut_label }}</span>
  </div>

  <div class="budget-header__main">
    <div>
      <h1 class="budget-title">{{ projet.nom }}</h1>
      <div class="budget-meta">
        <span>Secteur : <strong>{{ projet.secteur }}</strong></span>
        {% if projet.created_at %}
          <span>Ann√©e : <strong>{{ projet.created_at.year }}</strong></span>
        {% endif %}
      </div>
    </div>
    <div class="budget-header__context">
      <div class="context-item">
        <span class="muted">Budget pr√©visionnel</span>
        <strong>{{ "%.2f"|format(total_charges) }}‚Ç¨</strong>
      </div>
      <div class="context-item">
        <span class="muted">Base produits ({{ bs.base_label or "demand√©" }})</span>
        <strong>{{ "%.2f"|format(total_produits) }}‚Ç¨</strong>
      </div>
    </div>
  </div>

  <div class="budget-nav" role="navigation" aria-label="Navigation budget">
    <a class="btn btn-sm {{ 'btn-primary' if tab == 'synthese' or request.path.endswith('/budget/synthese') else 'btn-outline-primary' }}"
       href="{{ url_for('projets.projet_budget_synthese', projet_id=projet.id) }}">Synth√®se</a>
    <a class="btn btn-sm {{ 'btn-primary' if tab == 'charges' or request.path.endswith('/budget/charges') else 'btn-outline-primary' }}"
       href="{{ url_for('projets.projet_budget_charges', projet_id=projet.id) }}">Charges</a>
    <a class="btn btn-sm {{ 'btn-primary' if tab == 'produits' or request.path.endswith('/budget/produits') else 'btn-outline-primary' }}"
       href="{{ url_for('projets.projet_budget_produits', projet_id=projet.id) }}">Produits</a>
    <a class="btn btn-sm {{ 'btn-primary' if tab == 'ventilation' or request.path.endswith('/budget/ventilation') else 'btn-outline-primary' }}"
       href="{{ url_for('projets.projet_budget_ventilation', projet_id=projet.id) }}">Ventilation / Financeurs</a>
  </div>
</div>
