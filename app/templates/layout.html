<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>App Gestion</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <meta name="csrf-token" content="{{ csrf_token() }}">

  <style>
    :root{
      color-scheme: light dark;

      --bg: #0b1020;
      --bg-grad-1: #070b16;
      --bg-grad-2: #0b1020;

      --surface: rgba(18,26,51,.78);
      --surface-strong: #121a33;
      --surface-soft: rgba(255,255,255,.04);

      --text: #e8ecff;
      --muted: #9aa6d6;

      --border: rgba(255,255,255,.10);
      --border-soft: rgba(255,255,255,.12);
      --border-hard: rgba(255,255,255,.18);

      --accent: #6aa5ff;
      --danger: #ff6a6a;
      --ok: #52d17c;
      --warn: #ffcc66;

      --shadow: 0 10px 30px rgba(0,0,0,.25);

      --input-bg: rgba(255,255,255,.05);
      --input-text: var(--text);
      --input-border: var(--border-soft);

      --option-bg: var(--surface-strong);
      --option-text: var(--text);

      --focus: rgba(106,165,255,.35);
    }

    html[data-theme="light"]{
      color-scheme: light;

      --bg: #f4f6fb;
      --bg-grad-1: #ffffff;
      --bg-grad-2: #eef2ff;

      --surface: #ffffff;
      --surface-strong: #ffffff;
      --surface-soft: #f6f8ff;

      --text: #0f172a;
      --muted: #475569;

      --border: rgba(15,23,42,.12);
      --border-soft: rgba(15,23,42,.16);
      --border-hard: rgba(15,23,42,.22);

      --accent: #1d4ed8;
      --danger: #dc2626;
      --ok: #16a34a;
      --warn: #d97706;

      --shadow: 0 10px 26px rgba(2,6,23,.08);

      --input-bg: #ffffff;
      --input-text: var(--text);
      --input-border: rgba(15,23,42,.20);

      --option-bg: #ffffff;
      --option-text: var(--text);

      --focus: rgba(29,78,216,.18);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, "Segoe UI", Roboto, Arial;
      background: linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2));
      color: var(--text);
    }

    a{ color:inherit; text-decoration:none; }
    a:hover{ text-decoration: underline; }

    .wrap{ max-width:1180px; margin:0 auto; padding:14px 16px; }
    .container{ max-width:1180px; margin:0 auto; padding:18px 16px 46px; }

    .topbar{
      position:sticky; top:0; z-index:10;
      background: color-mix(in srgb, var(--bg) 92%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid color-mix(in srgb, var(--border) 85%, transparent);
    }

    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{ font-weight:900; letter-spacing:.3px; margin-right:10px; }

    .pill{
      padding:8px 12px;
      border:1px solid var(--border-soft);
      border-radius:999px;
      background: color-mix(in srgb, var(--surface) 70%, transparent);
      cursor:pointer;
      user-select:none;
      transition:border-color .15s ease, background .15s ease;
    }

    .pill:hover{ border-color: color-mix(in srgb, var(--accent) 55%, var(--border)); }
    .pill.active{
      border-color: color-mix(in srgb, var(--accent) 60%, transparent);
      background: color-mix(in srgb, var(--accent) 12%, var(--surface));
    }

    .right{ margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .tag{
      font-size:12px; color: var(--muted);
      border:1px dashed color-mix(in srgb, var(--border-hard) 70%, transparent);
      padding:6px 10px; border-radius:999px;
      background: color-mix(in srgb, var(--surface) 78%, transparent);
    }

    .stack{ display:flex; flex-direction:column; gap:14px; }
    .spacer{ height:12px; }

    .flash{ border-radius:12px; padding:10px 12px; border:1px solid var(--border); background: var(--surface-soft); }
    .flash.success{ border-color: color-mix(in srgb, var(--ok) 60%, var(--border)); }
    .flash.danger{ border-color: color-mix(in srgb, var(--danger) 60%, var(--border)); }
    .flash.warning{ border-color: color-mix(in srgb, var(--warn) 60%, var(--border)); }

    #themeToggle{
      display:flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
      font-weight:700;
    }
  </style>
  {% block head_extra %}{% endblock %}
</head>

<body>
  {% set ep = request.endpoint or '' %}
  {% set embed = request.args.get('embed') %}

  {% if not embed %}
  <div class="topbar">
    <div class="wrap">
      <div class="nav">
        <div class="brand">App Gestion</div>

        {% if current_user.is_authenticated %}
          {% if not current_user.has_role("admin_tech") %}

            {# ----------------------------
               MENU UTILISATEUR (RBAC)
               - On cache ce que l'user n'a pas le droit de voir
               - Le serveur reste la source de vÃ©ritÃ© (require_perm)
            ---------------------------- #}

            {% if can('dashboard:view') %}
              <a class="pill {% if ep.startswith('main.dashboard') %}active{% endif %}" href="{{ url_for('main.dashboard') }}">Dashboard ğŸ“Š</a>
            {% endif %}

            {% if can('subventions:view') %}
              <a class="pill {% if ep.startswith('main.subventions') %}active{% endif %}" href="{{ url_for('main.subventions_list') }}">Subventions ğŸ’¶</a>
            {% endif %}

            {% if can('depenses:create') %}
              <a class="pill {% if ep.startswith('budget.depense_new') %}active{% endif %}" href="{{ url_for('budget.depense_new') }}">Nouvelle dÃ©pense â•ğŸ’¸</a>
            {% endif %}

            {% if can('depenses:view') %}
              <a class="pill {% if ep.startswith('budget.depenses_list') %}active{% endif %}" href="{{ url_for('budget.depenses_list') }}">DÃ©penses ğŸ’¸</a>
            {% endif %}

            {% if can('projets:view') %}
              <a class="pill {% if ep.startswith('projets.') %}active{% endif %}" href="{{ url_for('projets.projets_list') }}">Projets ğŸ—‚ï¸</a>
            {% endif %}

            {% if can('participants:view') %}
              <a class="pill {% if ep.startswith('participants.') %}active{% endif %}" href="{{ url_for('participants.list_participants') }}">Participants ğŸ‘¥</a>
            {% endif %}

            {% if can('inventaire:view') %}
              <a class="pill {% if ep.startswith('inventaire_materiel.') %}active{% endif %}" href="{{ url_for('inventaire_materiel.list_items') }}">Inventaire ğŸ“¦</a>
            {% endif %}

            {% if can('emargement:view') %}
              <a class="pill {% if ep.startswith('activite.') or ep.startswith('kiosk.') %}active{% endif %}" href="{{ url_for('activite.index') }}">Ã‰margement âœï¸</a>
            {% endif %}

            {% if can('pedagogie:view') %}
              <a class="pill {% if ep.startswith('pedagogie.') %}active{% endif %}" href="{{ url_for('pedagogie.referentiels_list') }}">PÃ©dagogie âš™ï¸ğŸ“˜</a>
              <a class="pill {% if ep.startswith('pedagogie.suivi_pedagogique') %}active{% endif %}" href="{{ url_for('pedagogie.suivi_pedagogique') }}">Suivi PÃ©dagogique ğŸ“ˆğŸ“</a>
            {% endif %}

            {% if can('bilans:view') %}
              <a class="pill {% if ep.startswith('bilans.') %}active{% endif %}" href="{{ url_for('bilans.bilans_lourds', year=2026) }}">Bilans lourds ğŸ§ </a>
            {% endif %}

            {% if can('stats:view') %}
              <a class="pill {% if ep.startswith('main.stats_bilans') or ep.startswith('main.bilan_global') or ep.startswith('main.stats') %}active{% endif %}" href="{{ url_for('main.stats_bilans') }}">Stats &amp; bilans ğŸ§ ğŸ“Š</a>
            {% endif %}

            {# DonnÃ©es ateliers: soit une perm dÃ©diÃ©e statsimpact:view, soit on rÃ©utilise stats:view #}
            {% if can('statsimpact:view') or can('stats:view') %}
              <a class="pill {% if ep.startswith('statsimpact.') %}active{% endif %}" href="{{ url_for('statsimpact.dashboard') }}">DonnÃ©es ateliers ğŸ› ï¸ğŸ“‹</a>
            {% endif %}

            {% if can('controle:view') %}
              <a class="pill {% if ep.startswith('main.controle') %}active{% endif %}" href="{{ url_for('main.controle') }}">ContrÃ´le</a>
            {% endif %}

            {% if can('secteurs:edit') %}
              <a class="pill {% if ep.startswith('admin.secteurs') %}active{% endif %}" href="{{ safe_url_for('admin.secteurs') }}">Secteurs ğŸ§©</a>
            {% endif %}

          {% else %}
            {# MENU ADMIN TECH #}
            <a class="pill {% if ep.startswith('main.dashboard') %}active{% endif %}" href="{{ url_for('main.dashboard') }}">Dashboard</a>
            <a class="pill {% if ep.startswith('admin.users') %}active{% endif %}" href="{{ url_for('admin.users') }}">Ã‰quipe</a>
            {% if can('secteurs:edit') %}
              <a class="pill {% if ep.startswith('admin.secteurs') %}active{% endif %}" href="{{ safe_url_for('admin.secteurs') }}">Secteurs ğŸ§©</a>
            {% endif %}
            {% if can('admin:rbac') %}
              <a class="pill {% if ep.startswith('admin.droits') %}active{% endif %}" href="{{ url_for('admin.droits') }}">Droits ğŸ”</a>
            {% endif %}
            <a class="pill {% if ep.startswith('main.controle') %}active{% endif %}" href="{{ url_for('main.controle') }}">ContrÃ´le âš™</a>
          {% endif %}

          <div class="right">
            <div class="pill" id="themeToggle" title="Changer de thÃ¨me">ğŸŒ™</div>

            <div class="tag">
              {{ current_user.nom }} Â· {{ current_user.role_codes|join(', ') }}
              {% if current_user.secteur_assigne %} Â· {{ current_user.secteur_assigne }}{% endif %}
            </div>

            <form method="post" action="{{ url_for('auth.logout') }}" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="pill" type="submit">DÃ©connexion</button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="stack">
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        </div>
        <div class="spacer"></div>
      {% endif %}
    {% endwith %}

    {% block body %}{% endblock %}
  </div>

  <script>
  (function(){
    const root = document.documentElement;
    const btn  = document.getElementById("themeToggle");
    if(!btn) return;

    function apply(theme){
      root.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      btn.textContent = theme === "dark" ? "ğŸŒ™" : "â˜€ï¸";
      btn.title = theme === "dark" ? "Passer en thÃ¨me clair (finance)" : "Passer en thÃ¨me sombre";
    }

    const saved = localStorage.getItem("theme");
    if(saved){
      apply(saved);
    }else{
      apply("light");
    }

    btn.addEventListener("click", ()=>{
      const current = root.getAttribute("data-theme") || "dark";
      apply(current === "dark" ? "light" : "dark");
    });
  })();
  </script>

  {% block scripts_extra %}{% endblock %}
</body>
</html>
